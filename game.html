<!doctype html>
<html>
<head>
	<style type="text/css">
		body{
			background-color: #000;
		}
		#gameMargin{
			position: relative;
			margin-top: 1em;
			width: 100%;
			height: 100%;
		}

		#playArea{
			image-rendering: pixelated;
			image-rendering: -moz-crisp-edges;
			image-rendering: crisp-edges;
			position: relative;
			margin: auto;
			border: 1px solid #000;
			width: 600px;
			height: 400px;
		}
	</style>
	<script type="text/javascript" src="generator.js"></script> 
	<script type="text/javascript" src="elementSprite.js"></script>
	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript">
		var gameScale = 5, cellSize = 12;
		var sprites = {};
		var maps = Array();
		var currentMap = undefined;
		var playArea;

		function initialize(step){
			if(step == undefined) step = 'initialize';
			switch(step){
				case 'initialize':
					playArea = document.getElementById('playArea');
					setTimeout(function(){
						initialize('load stone sprite');
					}, 1);
					break;
				case 'load stone sprite':
					sprites.stone = new spriteSet('stone.sprite', function(){
						setTimeout(function(){
							initialize('load floor sprite');
						}, 1);
					});
					break;
				case 'load floor sprite':
					sprites.ground = new spriteSet('ground.sprite', function(){
						setTimeout(function(){
							initialize('load map');
						}, 1);
					});
					break;
				case 'load map':
					maps[maps.length] = buildMap('dungeon');
					currentMap = maps.length - 1;
					renderMap(currentMap);
					setTimeout(function(){initialize('finish');}, 1);
					break;
				case 'finish':
					playDemo();
			}
		}

		function renderMap(idx){
			var stoneSprite = new spriteClass(sprites.stone);
			stoneSprite.setScale(gameScale);

			var groundSprite = new spriteClass(sprites.ground);
			groundSprite.setScale(gameScale);

			var x, y, drawX, drawY;
			var map = maps[idx];
			for(x = 0; x < map.length; x++){
				for(y = 0; y < map[x].length; y++){
					drawX = x * cellSize * gameScale;
					drawY = y * cellSize * gameScale;

					switch(map[x][y]){
						case '.': case '<': case '>': // <-- those need to be made stairwells
							groundSprite.rotate(Math.PI / 2);
							groundSprite.drawRandomArea(playArea, drawX, drawY, cellSize, cellSize);
							break;
						case '#':
							stoneSprite.drawFrame(playArea, Math.floor(Math.random() * 25), drawX, drawY);
							break;
						default:
							continue;
					}
				}
			}
		}

		function buildMap(mapType){
			var error = 0;
			var size = Math.floor(Math.random() * 60);
			map = new mapBuilder();
			switch(mapType){
				case 'dungeon':
					map.buildDungeon({width : 50, height: 30});
					/*

					map.buildDungeon({
						'width' : 5 + size, 
						'height' : 5 + size,
						'stairdown' : true,
						'stairup' : true,
						'roomscale' : 1
					});
					*/
					break;
				case 'swamp':
					map.buildSwamp({
						'width' : 30 + size, 
						'height' : 30 + size
					});
					break;
				case 'forest':
					map.buildForest({
						'width' : 30 + size, 
						'height' : 30 + size
					});
					break;
				default:
					alert('Invalid map type');
					error = 1;
					map = [];
			}

			if(!error){
				map = map.map;
				var lineStr;
				$('#mapContent').html('');
				for(var y = 0; y < map[0].length; y++){
					lineStr = "";
					for(var x = 0; x < map.length; x++){
						lineStr += map[x][y];
					}
					$('#mapContent').append(lineStr + "\n");
				}
			}
			return map;
		}

		window.onload = function(){
			initialize();
		};

		function playDemo(){
		}
	</script>
</head>
<body>
	<div id="gameMargin">
		<div id="playArea">
		</div>
	</div>
</body>
</html>
